<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemical Usage Log - ChemTrack</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a modern look */
        body {
            font-family: "Inter", sans-serif;
            /* Default Light Mode Colors */
            --bg-color: #f8fafc;
            --text-color-primary: #1a202c; /* gray-900 */
            --text-color-secondary: #4a5568; /* gray-700 */
            --navbar-bg: #ffffff;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --dropdown-bg: #ffffff;
            --dropdown-item-hover-bg: #f0f2f5;
            --header-text-color: #2d3748; /* gray-800 */
            --link-color: #6366f1; /* indigo-500 */
            --link-hover-color: #4f46e5; /* indigo-600 */
            --footer-bg: #2d3748; /* gray-800 */
            --footer-text: #ffffff;
            --footer-link: #a0aec0; /* gray-400 */
            --footer-link-hover: #ffffff;
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --table-header-bg: #edf2f7; /* gray-200 */
            --table-row-hover-bg: #f7fafc; /* gray-100 */
            --alert-info-bg: #3b82f6;
            --alert-success-bg: #22c55e;
            --alert-error-bg: #ef4444;
            --alert-warning-bg: #f59e0b;

            background-color: var(--bg-color);
            color: var(--text-color-primary);
            margin: 0;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Mode Colors */
        body[data-theme="dark"] {
            --bg-color: #1a202c;
            --text-color-primary: #e2e8f0;
            --text-color-secondary: #a0aec0;
            --navbar-bg: #2d3748;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --dropdown-bg: #2d3748;
            --dropdown-item-hover-bg: #4a5568;
            --header-text-color: #e2e8f0;
            --link-color: #818cf8;
            --link-hover-color: #6366f1;
            --footer-bg: #1a202c;
            --footer-text: #e2e8f0;
            --footer-link: #a0aec0;
            --footer-link-hover: #ffffff;
            --input-bg: #2d3748;
            --input-border: #4a5568;
            --table-header-bg: #4a5568;
            --table-row-hover-bg: #2d3748;
            --alert-info-bg: #60a5fa;
            --alert-success-bg: #4ade80;
            --alert-error-bg: #f87171;
            --alert-warning-bg: #fbbf24;
        }

        /* Navbar styling */
        .navbar {
            background-color: var(--navbar-bg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            z-index: 10;
            transition: background-color 0.3s ease;
        }
        .navbar .text-gray-900 { color: var(--text-color-primary); }
        .navbar .text-indigo-600 { color: var(--link-color); }
        .navbar .text-gray-700 { color: var(--text-color-secondary); }
        .navbar .hover\:text-indigo-600:hover { color: var(--link-hover-color); }

        @media (min-width: 768px) {
            .navbar {
                padding: 1rem 2rem;
            }
        }
        @media (min-width: 1024px) {
            .navbar {
                padding: 1rem 3rem;
            }
        }

        /* Dropdown menu styling */
        .dropdown-menu {
            position: absolute;
            right: 1.5rem;
            top: 4.5rem;
            background-color: var(--dropdown-bg);
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            min-width: 12rem;
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out, visibility 0.2s, background-color 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-color-secondary);
            display: block;
            text-decoration: none;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background-color: var(--dropdown-item-hover-bg);
            color: var(--link-hover-color);
        }
        .dropdown-item:first-child {
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .dropdown-item:last-child {
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }
        .dropdown-header {
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--header-text-color);
            border-bottom: 1px solid var(--border-color);
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        /* Main content section padding */
        .section-padding {
            padding: 2rem 1rem;
            flex-grow: 1;
        }
        @media (min-width: 768px) {
            .section-padding {
                padding: 3rem 2rem;
            }
        }
        @media (min-width: 1024px) {
            .section-padding {
                padding: 4rem 3rem;
            }
        }

        /* Form and Card styling */
        .form-card, .table-card, .management-card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .input-field, .select-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            background-color: var(--input-bg);
            color: var(--text-color-primary);
            transition: border-color 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            outline: none;
        }
        .input-field:focus, .select-field:focus {
            border-color: var(--link-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .btn-primary {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
        }
        .btn-secondary {
            background-color: #4a5568; /* gray-700 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #2d3748; /* gray-800 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }


        .usage-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            color: var(--text-color-primary);
        }
        .usage-table th, .usage-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }
        .usage-table th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            color: var(--header-text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .usage-table tbody tr:hover {
            background-color: var(--table-row-hover-bg);
            transition: background-color 0.2s ease;
        }
        .usage-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Footer styling */
        footer {
            background-color: var(--footer-bg);
            color: var(--footer-text);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin-top: auto;
        }
        footer a {
            color: var(--footer-link);
            transition: color 0.3s ease;
        }
        footer a:hover {
            color: var(--footer-link-hover);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="flex items-center">
            <a href="homepage.html" class="text-3xl font-bold text-gray-900 tracking-tight">
                <span class="text-indigo-600">Chem</span>Track
            </a>
        </div>
        <div class="relative">
            <button id="settingsBtn" class="flex items-center space-x-2 text-gray-700 hover:text-indigo-600 focus:outline-none">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.5 1.58.5z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="hidden md:block text-lg font-medium">Settings</span>
            </button>
            <div id="settingsDropdown" class="dropdown-menu">
                <div class="dropdown-header">
                    <span id="userNameDisplay">Loading...</span> (<span id="userRoleDisplay">Loading...</span>)
                    <br>
                    <span id="userEmailDisplay" class="text-sm text-gray-500">Loading...</span>
                </div>
                <a href="user-dashboard.html" class="dropdown-item">User Dashboard</a>
                <a href="admin-dashboard.html" class="dropdown-item">Admin Dashboard</a>
                <a href="#" class="dropdown-item" id="darkModeToggle">Toggle Mode</a>
                <a href="#" class="dropdown-item bg-red-600 hover:bg-red-700 text-white font-semibold rounded-b-lg" id="logoutBtn">Logout</a>
            </div>
        </div>
    </nav>

    <main class="pt-20 section-padding">
        <h1 class="text-4xl font-extrabold text-gray-900 text-center mb-12">
            Log Chemical Usage
        </h1>

        <div class="max-w-4xl mx-auto flex justify-end mb-6">
            <button id="manageInventoryBtn" class="btn-secondary px-6 py-3">Manage Inventory</button>
        </div>

        <div class="max-w-4xl mx-auto grid grid-cols-1 gap-8">
            <!-- Chemical Usage Form -->
            <div class="form-card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Record New Usage</h2>
                <form id="usageForm" class="space-y-4">
                    <div>
                        <label for="chemicalName" class="block text-sm font-medium text-gray-700 mb-1">Chemical Name</label>
                        <select id="chemicalName" class="select-field" required>
                            <option value="">Select a chemical</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <p id="currentQuantityDisplay" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="quantityUsed" class="block text-sm font-medium text-gray-700 mb-1">Quantity Used</label>
                            <input type="number" id="quantityUsed" class="input-field" step="0.01" min="0.01" required>
                        </div>
                        <div>
                            <label for="unit" class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                            <select id="unit" class="select-field" required>
                                <option value="ml">ml</option>
                                <option value="g">g</option>
                                <option value="L">L</option>
                                <option value="kg">kg</option>
                                <option value="units">units</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="usageDate" class="block text-sm font-medium text-gray-700 mb-1">Date of Usage</label>
                            <input type="date" id="usageDate" class="input-field" required>
                        </div>
                        <div>
                            <label for="usageTime" class="block text-sm font-medium text-gray-700 mb-1">Time of Usage</label>
                            <input type="time" id="usageTime" class="input-field" required>
                        </div>
                    </div>
                    <div>
                        <label for="purpose" class="block text-sm font-medium text-gray-700 mb-1">Purpose / Experiment Name</label>
                        <textarea id="purpose" class="input-field h-24 resize-y" placeholder="e.g., Synthesis of Compound X, Routine Cleaning, Titration Experiment" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary w-full">Log Usage</button>
                </form>
            </div>

            <!-- Manage Chemical Inventory Section (Initially Hidden) -->
            <div id="inventoryManagementSection" class="management-card hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Chemical Inventory</h2>
                <div class="space-y-4">
                    <div>
                        <label for="manageChemicalName" class="block text-sm font-medium text-gray-700 mb-1">Chemical Name</label>
                        <select id="manageChemicalName" class="select-field" required>
                            <option value="">Select a chemical</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <p id="manageCurrentQuantityDisplay" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                    <div>
                        <label for="adjustmentAmount" class="block text-sm font-medium text-gray-700 mb-1">Adjustment Amount</label>
                        <input type="number" id="adjustmentAmount" class="input-field" step="0.01" min="0" placeholder="Enter quantity to add or remove" required>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button type="button" id="addQuantityBtn" class="btn-primary flex-1">Add Quantity</button>
                        <button type="button" id="removeQuantityBtn" class="btn-danger flex-1">Remove Quantity</button>
                    </div>
                    <button type="button" id="closeManagementBtn" class="btn-secondary w-full mt-4">Close Management</button>
                </div>
            </div>

            <!-- Recent Usage Logs Table -->
            <div class="table-card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Recent Usage Logs</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                    <table class="usage-table">
                        <thead>
                            <tr>
                                <th>Chemical</th>
                                <th>Quantity</th>
                                <th>Date & Time</th> <!-- Updated column header -->
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody id="usageLogsTableBody">
                            <!-- Usage logs will be loaded here by JavaScript -->
                            <tr><td colspan="4" class="text-center py-4 text-gray-500">No usage logs found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 px-4 md:px-8 lg:px-12 text-center mt-8">
        <p>&copy; 2025 ChemTrack. All rights reserved.</p>
        <div class="mt-4 text-sm">
            <a href="#" class="text-gray-400 hover:text-white mx-2">Privacy Policy</a>
            <span class="text-gray-500">|</span>
            <a href="#" class="text-gray-400 hover:text-white mx-2">Terms of Service</a>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Added signInWithCustomToken and signInAnonymously imports
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // IMPORTANT: Using the firebaseConfig provided by the user.
        const firebaseConfig = {
            apiKey: "AIzaSyBxxDfMvpB3dTCzBeX2vTd8R2ZhmayHXo4",
            authDomain: "aditya-suryawanshi-chem.firebaseapp.com",
            projectId: "aditya-suryawanshi-chem",
            storageBucket: "aditya-suryawanshi-chem.firebasestorage.app",
            messagingSenderId: "1056550959635",
            appId: "1:1056550959635:web:9944e9ae52f3b559a7dde6",
            measurementId: "G-XXP0XPBNW0"
        };


        let app, auth, db;
        let currentUserId = null; // To store the authenticated user's UID
        let chemicalsData = {}; // To store chemical inventory data keyed by name
        let isAuthReady = false; // Flag to indicate if auth state has been determined

        // List of chemicals provided by the user
        const predefinedChemicals = [
            "Acetamide", "Acetic Acid", "Acetanilide", "Acetone", "Acetyl Salicylic Acid (OOH)", "Activated Zinc metal Powder",
            "Agar Agar Powder", "Alizarine", "Aluminium Sulphate", "Ammonia", "Ammonium Chloride", "Ammonium Ferrous Sulfate",
            "Ammonium Hydroxide", "Ammonium Iron (II) Sulphate)", "Ammonium Oxalate", "Ammonium Thiocyanate", "Aniline",
            "Barium Chloride", "Barium Hydroxide", "Benzaldehyde", "Benzamide", "Benzene", "Benzoic Acid", "Benzoinoxime",
            "Benzidine", "Bleaching Powder", "Brass Fillings", "Bromine water", "Buffer capsules", "Butan-2-one Extrapure",
            "Calcon Carboxylic Acid", "Calcium Carbonate", "Calcium Chloride", "Calcium Tetrachloride", "Carboxy Methyl Cellulose",
            "Cellulose Powder", "Cetylpyridinium bromide", "Charcoal Powder", "Cobalt Nitrate", "Cobaltous Chloride",
            "Cobaltous chloride", "Copper filings", "Copper Sulphate", "Cyclohexanone", "Dextrose", "Diethyl Ether",
            "Dimethyl Glyoxime", "di-Sodium Phosphate", "Diphenylamine Ind.", "Dithiozone", "Dolomite Powder", "EDTA",
            "2,4-Dinitrophenol", "Ethyl Acetate", "Ethyl Alcohol", "Ethyl Benzoate", "Ethyl Benzoate for Synthesis",
            "Ethyl Cellulose", "Ethyl Methyl Ketone", "Ethylenediamine", "Ethanol", "Ether Solvent", "Fumaric Acid",
            "Formaldehyde", "Formalin", "Formic Acid", "Furfuraldehyde", "Furfuryl Alcohol", "Fehling Solution A",
            "Fehling Solution B", "Ferric Chloride", "Ferrous Sulphate", "Glacial Acetic Acid", "Glucose (Dextrose/AVOS?)",
            "Glycerin (Glycanine/Glycerol?)", "Glycine", "Guar Gum", "Hexane", "Hydrochloric Acid", "Hydrogen Peroxide",
            "Hydroxyethyl Cellulose", "L-Alginine", "L-Cystine", "Iodine", "Iodine Crystal", "Iron Metal (Powder)",
            "L-Volume for biochemistry", "Liquid Paraffin (hard)", "Liquid Paraffin (Light)", "Lime Water", "Leasel Acatate",
            "Leal Nitrade", "Methyl Cellulose", "n-Butyl Alcohol", "Magnesium Sulphate", "Ortho Phosphoric Acid", "2-Nitrophenol",
            "3-Nitro Aniline", "Oxalic Acid", "Nitrobenzene", "Methyl Acetate", "Nickel Chloride", "Mercuric Chloride",
            "Picric Acid", "Phthalic Acid", "1-Naphthol", "Methyl Orange", "Polyvinyl Alcohol (cold)", "Potassium Carbonate",
            "Potassium Dichromate", "p-Nitroaniline", "Methylene Blue", "Potassium Nitrate", "Ninhydrin", "Methanesulfonic Acid",
            "n-Butyl Acetate", "Phthalic Anhydride", "Potassium Chloride", "Methyl Alcohol", "Nitroso-R Salt", "Nickel Nitrate",
            "Methanol", "β-Naphthol", "α-Naphthol", "Naphthalene", "p-Nitrophenol", "Nitrobenzene", "Potassium Permanganate",
            "Potassium Persulfate", "Potassium Bromide", "Potassium Fluoride", "Potassium Thiocyanate", "Potassium Iodide",
            "Potassium Dithionite", "Nitric Acid", "Orthophosphate", "Nickel Acetate Hexahydrate", "Phosphoric Acid",
            "Nickel Sulphate", "Potassium Hydroxide", "Potassium Ferrocyanide", "Phenolphthalein Indicator", "Phenol",
            "Potassium Chromate", "p-Toluidine", "Petroleum Ether", "1,10-Phenanthroline Hydrate", "Potassium Carbonate Anhydrous",
            "Phenyl Hydrazine", "Hydroquinone", "Paraffin Wax Pure", "Phthalic Anhydride", "Rubeanic Acid", "Resorcinol",
            "Sodium Carbonate", "Sodium Nitrate", "Sodium Hydroxide Pellets", "Sodium Phosphate Dibasic", "Sodium Thiosulfate",
            "Semicarbazide Hydrochloride", "Sodium Potassium Tartrate", "Sodium Sulphate Anhydrous", "Sodium Azide",
            "Sodium Iodide", "Sodium Acetate", "Sodium Sulphate", "Sulphur Powder", "Sodium Bicarbonate", "Sodium Nitroprusside",
            "Schiff's Reagent", "Stannous Chloride", "Urease", "Sodium Sulphite Flakes", "Starch Indicator",
            "Silver Nitrate (AgNO₃)", "Sodium Acetate", "Sulfuric Acid", "Spirit (Rectified Spirit)", "Salicylic Acid",
            "Thiourea", "Tollens Reagent", "Tollene", "Urea", "Zinc Sulphate", "Zinc Choloride Powder", "Zinc Oxide Pure", "Zinc Dust"
        ];

        // Initialize Firebase and set up authentication listener
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Attempt to sign in with custom token if available
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    // If no custom token, the user is not authenticated through the Canvas environment.
                    // The onAuthStateChanged listener will handle the redirection.
                    console.log("No initial auth token found. User will be redirected if not already signed in.");
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("User is signed in:", currentUserId);
                        isAuthReady = true; // Set auth ready flag
                        await fetchUserProfile(currentUserId);
                        await initializeChemicalInventory(); // Initialize chemical inventory
                        // populateChemicalDropdowns() will be called by onSnapshot listener
                        listenForUsageLogs(currentUserId); // Start listening for logs
                    } else {
                        currentUserId = null;
                        isAuthReady = true; // Auth state determined (no user)
                        console.log("No user is signed in. Redirecting to login.");
                        alertPlaceholder("You are not logged in. Redirecting to login page.", "error");
                        setTimeout(() => {
                            window.location.href = 'auth-page.html#login';
                        }, 2000);
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                alertPlaceholder("Failed to initialize application. Please try again.", "error");
            }
        }

        // Fetch user profile data (for dropdown display and role check)
        async function fetchUserProfile(uid) {
            try {
                if (!uid) {
                    console.error("fetchUserProfile: UID is null or undefined.");
                    document.getElementById('userNameDisplay').textContent = 'Guest';
                    document.getElementById('userRoleDisplay').textContent = 'N/A';
                    document.getElementById('userEmailDisplay').textContent = 'guest@example.com';
                    return;
                }

                const userDocRef = doc(db, 'users', uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    document.getElementById('userNameDisplay').textContent = userData.name || 'User';
                    document.getElementById('userEmailDisplay').textContent = userData.email || 'N/A';
                    document.getElementById('userRoleDisplay').textContent = userData.role ? userData.role.charAt(0).toUpperCase() + userData.role.slice(1) : 'N/A';
                } else {
                    console.warn("User profile document does not exist for UID:", uid);
                    document.getElementById('userNameDisplay').textContent = 'User Not Found';
                    document.getElementById('userRoleDisplay').textContent = 'N/A';
                    document.getElementById('userEmailDisplay').textContent = 'N/A';
                    alertPlaceholder("User profile missing. Please ensure your profile is complete.", "warning");
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                alertPlaceholder("Failed to load user profile.", "error");
            }
        }

        // Initialize the chemical inventory in Firestore if it's empty
        async function initializeChemicalInventory() {
            const chemicalsCollectionRef = collection(db, 'chemicals');
            const q = query(chemicalsCollectionRef);

            try {
                // Fetch all existing chemicals to check for missing ones
                const existingChemicalsSnapshot = await getDocs(q);
                const existingChemicalNames = new Set();
                existingChemicalsSnapshot.forEach(doc => {
                    existingChemicalNames.add(doc.data().name);
                    chemicalsData[doc.data().name] = { id: doc.id, ...doc.data() }; // Also populate chemicalsData from existing
                });
                console.log("Existing chemicals in Firestore:", Array.from(existingChemicalNames));

                let chemicalsAddedCount = 0;
                for (const chemicalName of predefinedChemicals) {
                    if (!existingChemicalNames.has(chemicalName)) {
                        try {
                            await addDoc(chemicalsCollectionRef, {
                                name: chemicalName,
                                currentQuantity: 0, // Set initial quantity to 0 as requested by user
                                unit: 'g', // Default unit, user can change via admin panel later
                                lowStockThreshold: 100, // Default low stock threshold
                                lastUpdated: serverTimestamp()
                            });
                            console.log(`Successfully added missing chemical: ${chemicalName} with initial quantity 0.`);
                            chemicalsAddedCount++;
                        } catch (addError) {
                            console.error(`Error adding missing chemical ${chemicalName} to inventory:`, addError);
                        }
                    }
                }
                if (chemicalsAddedCount > 0) {
                    console.log(`Finished adding ${chemicalsAddedCount} missing chemicals.`);
                } else {
                    console.log("No new chemicals needed to be added from the predefined list.");
                }

                // Set up real-time listener for chemicals collection
                onSnapshot(q, (updatedSnapshot) => {
                    console.log("onSnapshot triggered. Number of documents:", updatedSnapshot.size); // New log
                    chemicalsData = {}; // Clear old data
                    updatedSnapshot.forEach(doc => {
                        chemicalsData[doc.data().name] = { id: doc.id, ...doc.data() };
                    });
                    console.log("Updated chemicalsData after onSnapshot:", chemicalsData); // New log
                    // Re-populate both dropdowns and update display if a chemical is selected
                    populateChemicalDropdowns();
                    const selectedChemicalUsage = document.getElementById('chemicalName').value;
                    if (selectedChemicalUsage) {
                        updateCurrentQuantityDisplay(selectedChemicalUsage, 'currentQuantityDisplay');
                    }
                    const selectedChemicalManage = document.getElementById('manageChemicalName').value;
                    if (selectedChemicalManage) {
                        updateCurrentQuantityDisplay(selectedChemicalManage, 'manageCurrentQuantityDisplay');
                    }
                }, (error) => {
                    console.error("Error listening to chemicals collection:", error);
                    alertPlaceholder("Failed to load chemical inventory updates.", "error"); // Changed message slightly
                });

            } catch (error) {
                console.error("Error initializing or fetching chemical inventory:", error);
                alertPlaceholder("Failed to load chemical inventory. Please check permissions.", "error");
            }
        }


        // Populate both chemical dropdowns with current quantities
        function populateChemicalDropdowns() {
            const selectElementUsage = document.getElementById('chemicalName');
            const selectElementManage = document.getElementById('manageChemicalName');

            // Clear existing options for both
            selectElementUsage.innerHTML = '<option value="">Select a chemical</option>';
            selectElementManage.innerHTML = '<option value="">Select a chemical</option>';

            // Sort chemicals alphabetically by name
            const sortedChemicalNames = Object.keys(chemicalsData).sort();

            console.log("Populating dropdowns with chemicalsData:", chemicalsData); // New log

            if (sortedChemicalNames.length === 0) {
                console.warn("No chemical data available to populate dropdowns."); // New log
            }

            sortedChemicalNames.forEach(chemicalName => {
                const chemical = chemicalsData[chemicalName];
                const optionText = `${chemical.name} (Current: ${chemical.currentQuantity} ${chemical.unit})`;

                const optionUsage = document.createElement('option');
                optionUsage.value = chemical.name;
                optionUsage.textContent = optionText;
                selectElementUsage.appendChild(optionUsage);

                const optionManage = document.createElement('option');
                optionManage.value = chemical.name;
                optionManage.textContent = optionText;
                selectElementManage.appendChild(optionManage);
            });
        }

        // Update the display for current quantity when a chemical is selected in either dropdown
        document.getElementById('chemicalName').addEventListener('change', (e) => {
            const selectedChemicalName = e.target.value;
            updateCurrentQuantityDisplay(selectedChemicalName, 'currentQuantityDisplay');
        });

        document.getElementById('manageChemicalName').addEventListener('change', (e) => {
            const selectedChemicalName = e.target.value;
            updateCurrentQuantityDisplay(selectedChemicalName, 'manageCurrentQuantityDisplay');
        });


        function updateCurrentQuantityDisplay(chemicalName, displayElementId) {
            const displayElement = document.getElementById(displayElementId);
            if (chemicalName && chemicalsData[chemicalName]) {
                const chemical = chemicalsData[chemicalName];
                displayElement.textContent = `Available: ${chemical.currentQuantity} ${chemical.unit}`;
                if (chemical.currentQuantity <= chemical.lowStockThreshold) {
                    displayElement.classList.add('text-red-500'); // Highlight low stock
                    displayElement.classList.remove('text-gray-600');
                } else {
                    displayElement.classList.remove('text-red-500');
                    displayElement.classList.add('text-gray-600');
                }
            } else {
                displayElement.textContent = '';
            }
        }


        // Handle form submission for logging chemical usage
        document.getElementById('usageForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUserId) {
                alertPlaceholder("Please log in to record usage.", "error");
                console.error("Attempted to log usage without a currentUserId.");
                return;
            }

            const chemicalName = document.getElementById('chemicalName').value;
            const quantityUsed = parseFloat(document.getElementById('quantityUsed').value);
            const unit = document.getElementById('unit').value;
            const usageDate = document.getElementById('usageDate').value;
            const usageTime = document.getElementById('usageTime').value;
            const purpose = document.getElementById('purpose').value.trim();

            console.log("Form submission initiated:");
            console.log("Chemical Name:", chemicalName);
            console.log("Quantity Used:", quantityUsed);
            console.log("Unit:", unit);
            console.log("Usage Date:", usageDate);
            console.log("Usage Time:", usageTime);
            console.log("Purpose:", purpose);
            console.log("Current User ID:", currentUserId);


            if (!chemicalName || isNaN(quantityUsed) || quantityUsed <= 0 || !unit || !usageDate || !usageTime || !purpose) {
                alertPlaceholder("Please fill in all fields correctly.", "error");
                console.error("Form validation failed: Missing or invalid fields.");
                return;
            }

            const chemicalInInventory = chemicalsData[chemicalName];
            if (!chemicalInInventory) {
                alertPlaceholder("Selected chemical not found in inventory.", "error");
                console.error("Selected chemical not found in local inventory data.");
                return;
            }

            if (quantityUsed > chemicalInInventory.currentQuantity) {
                alertPlaceholder(`Insufficient quantity of ${chemicalName}. Available: ${chemicalInInventory.currentQuantity} ${chemicalInInventory.unit}`, "error");
                console.error("Insufficient quantity for usage.");
                return;
            }

            try {
                const chemicalDocRef = doc(db, 'chemicals', chemicalInInventory.id);

                await runTransaction(db, async (transaction) => {
                    const chemicalDoc = await transaction.get(chemicalDocRef);
                    if (!chemicalDoc.exists()) {
                        throw "Chemical does not exist in inventory!";
                    }

                    const oldQuantity = chemicalDoc.data().currentQuantity;
                    const newQuantity = oldQuantity - quantityUsed;

                    if (newQuantity < 0) {
                        throw "Negative quantity after usage. Transaction aborted.";
                    }

                    // Update chemical quantity in inventory
                    transaction.update(chemicalDocRef, {
                        currentQuantity: newQuantity,
                        lastUpdated: serverTimestamp()
                    });

                    // Add usage log
                    const usageCollectionRef = collection(db, `users/${currentUserId}/chemical_usages`);
                    // Corrected: Create a new document reference first, then use transaction.set
                    const newUsageDocRef = doc(usageCollectionRef);
                    transaction.set(newUsageDocRef, {
                        chemicalName: chemicalName,
                        quantityUsed: quantityUsed,
                        unit: unit,
                        usageDate: usageDate,
                        usageTime: usageTime,
                        purpose: purpose,
                        userId: currentUserId,
                        timestamp: serverTimestamp()
                    });
                });

                alertPlaceholder("Chemical usage logged and inventory updated successfully!", "success");
                document.getElementById('usageForm').reset();
                document.getElementById('usageDate').valueAsDate = new Date();
                document.getElementById('usageTime').value = new Date().toTimeString().slice(0, 5);
                // The onSnapshot listener for chemicals will automatically update the dropdown and display
                // No need to call updateCurrentQuantityDisplay explicitly here for the usage form's display
                // as the real-time listener will handle it.

                // Low stock alert will be triggered by the onSnapshot listener for chemicals
            } catch (error) {
                console.error("Transaction failed:", error);
                let errorMessage = "Failed to log usage or update inventory. Please try again.";
                if (typeof error === 'string') {
                    errorMessage = error; // Custom error message from transaction
                } else if (error.code) {
                    errorMessage += ` Firebase Error: ${error.code}.`;
                    if (error.code === 'permission-denied') {
                        errorMessage += " Check your Firestore Security Rules.";
                    }
                }
                alertPlaceholder(errorMessage, "error");
            }
        });

        // Event listeners for Manage Inventory section
        document.getElementById('manageInventoryBtn').addEventListener('click', () => {
            document.getElementById('inventoryManagementSection').classList.remove('hidden');
            document.getElementById('manageChemicalName').value = ''; // Reset dropdown
            document.getElementById('adjustmentAmount').value = ''; // Reset amount
            document.getElementById('manageCurrentQuantityDisplay').textContent = ''; // Clear display
            alertPlaceholder("Inventory management section opened.", "info");
        });

        document.getElementById('closeManagementBtn').addEventListener('click', () => {
            document.getElementById('inventoryManagementSection').classList.add('hidden');
            alertPlaceholder("Inventory management section closed.", "info");
        });

        document.getElementById('addQuantityBtn').addEventListener('click', async () => {
            const chemicalName = document.getElementById('manageChemicalName').value;
            const amount = parseFloat(document.getElementById('adjustmentAmount').value);

            if (!chemicalName || isNaN(amount) || amount <= 0) {
                alertPlaceholder("Please select a chemical and enter a valid amount to add.", "error");
                return;
            }

            const chemicalInInventory = chemicalsData[chemicalName];
            if (!chemicalInInventory) {
                alertPlaceholder("Selected chemical not found in inventory.", "error");
                return;
            }

            try {
                const chemicalDocRef = doc(db, 'chemicals', chemicalInInventory.id);
                await runTransaction(db, async (transaction) => {
                    const chemicalDoc = await transaction.get(chemicalDocRef);
                    if (!chemicalDoc.exists()) {
                        throw "Chemical does not exist in inventory!";
                    }
                    const oldQuantity = chemicalDoc.data().currentQuantity;
                    const newQuantity = oldQuantity + amount;
                    transaction.update(chemicalDocRef, {
                        currentQuantity: newQuantity,
                        lastUpdated: serverTimestamp()
                    });
                });
                alertPlaceholder(`Added ${amount} ${chemicalInInventory.unit} to ${chemicalName}.`, "success");
                document.getElementById('adjustmentAmount').value = ''; // Clear input
                // The onSnapshot listener will update the display
            } catch (error) {
                console.error("Error adding quantity:", error);
                let errorMessage = "Failed to add quantity. Please try again.";
                if (typeof error === 'string') {
                    errorMessage = error;
                } else if (error.code) {
                    errorMessage += ` Firebase Error: ${error.code}.`;
                    if (error.code === 'permission-denied') {
                        errorMessage += " Check your Firestore Security Rules.";
                    }
                }
                alertPlaceholder(errorMessage, "error");
            }
        });

        document.getElementById('removeQuantityBtn').addEventListener('click', async () => {
            const chemicalName = document.getElementById('manageChemicalName').value;
            const amount = parseFloat(document.getElementById('adjustmentAmount').value);

            if (!chemicalName || isNaN(amount) || amount <= 0) {
                alertPlaceholder("Please select a chemical and enter a valid amount to remove.", "error");
                return;
            }

            const chemicalInInventory = chemicalsData[chemicalName];
            if (!chemicalInInventory) {
                alertPlaceholder("Selected chemical not found in inventory.", "error");
                return;
            }

            if (amount > chemicalInInventory.currentQuantity) {
                alertPlaceholder(`Cannot remove ${amount} ${chemicalInInventory.unit}. Only ${chemicalInInventory.currentQuantity} ${chemicalInInventory.unit} available.`, "error");
                return;
            }

            try {
                const chemicalDocRef = doc(db, 'chemicals', chemicalInInventory.id);
                await runTransaction(db, async (transaction) => {
                    const chemicalDoc = await transaction.get(chemicalDocRef);
                    if (!chemicalDoc.exists()) {
                        throw "Chemical does not exist in inventory!";
                    }
                    const oldQuantity = chemicalDoc.data().currentQuantity;
                    const newQuantity = oldQuantity - amount;
                    transaction.update(chemicalDocRef, {
                        currentQuantity: newQuantity,
                        lastUpdated: serverTimestamp()
                    });
                });
                alertPlaceholder(`Removed ${amount} ${chemicalInInventory.unit} from ${chemicalName}.`, "success");
                document.getElementById('adjustmentAmount').value = ''; // Clear input
                // The onSnapshot listener will update the display
            } catch (error) {
                console.error("Error removing quantity:", error);
                let errorMessage = "Failed to remove quantity. Please try again.";
                if (typeof error === 'string') {
                    errorMessage = error;
                } else if (error.code) {
                    errorMessage += ` Firebase Error: ${error.code}.`;
                    if (error.code === 'permission-denied') {
                        errorMessage += " Check your Firestore Security Rules.";
                    }
                }
                alertPlaceholder(errorMessage, "error");
            }
        });


        // Listen for real-time updates to usage logs
        function listenForUsageLogs(uid) {
            if (!uid) {
                console.warn("listenForUsageLogs: UID is null, cannot listen for logs.");
                return;
            }
            console.log("Setting up real-time listener for user usage logs for user:", uid);

            const usageCollectionRef = collection(db, `users/${uid}/chemical_usages`);
            const q = query(usageCollectionRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach(doc => {
                    logs.push({ id: doc.id, ...doc.data() });
                });
                console.log("Fetched user usage logs:", logs);
                displayUsageLogs(logs);
            }, (error) => {
                console.error("Error listening to user usage logs:", error);
                alertPlaceholder("Failed to load usage history.", "error");
            });
        }

        // Display usage logs in the table
        function displayUsageLogs(logs) {
            const tableBody = document.getElementById('usageLogsTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            if (logs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No usage logs found.</td></tr>';
                return;
            }

            logs.forEach(log => {
                const row = document.createElement('tr');
                const dateTimeDisplay = log.usageDate && log.usageTime ?
                                        `${new Date(log.usageDate).toLocaleDateString()} ${log.usageTime}` :
                                        'N/A';

                row.innerHTML = `
                    <td>${log.chemicalName}</td>
                    <td>${log.quantityUsed} ${log.unit}</td>
                    <td>${dateTimeDisplay}</td>
                    <td>${log.purpose}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Set current date and time as default for inputs
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('usageDate').value = `${yyyy}-${mm}-${dd}`;

            const hh = String(today.getHours()).padStart(2, '0');
            const min = String(today.getMinutes()).padStart(2, '0');
            document.getElementById('usageTime').value = `${hh}:${min}`;
        });

        // Toggle settings dropdown
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDropdown = document.getElementById('settingsDropdown');

        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown.classList.toggle('active');
        });

        window.addEventListener('click', (e) => {
            if (!settingsBtn.contains(e.target) && !settingsDropdown.contains(e.target)) {
                settingsDropdown.classList.remove('active');
            }
        });

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                alertPlaceholder("Logged out successfully!", "success");
                setTimeout(() => {
                    window.location.href = 'homepage.html';
                }, 1500);
            } catch (error) {
                console.error("Error logging out:", error);
                alertPlaceholder("Failed to log out. Please try again.", "error");
            }
        });

        // Dark Mode / Light Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            darkModeToggle.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
        }

        darkModeToggle.addEventListener('click', (e) => {
            e.preventDefault();
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            alertPlaceholder(`Switched to ${newTheme} mode!`, "info");
        });

        // Initialize theme on load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }

        // Placeholder for a custom alert/message box (since alert() is not allowed)
        function alertPlaceholder(message, type = "info") {
            const existingAlert = document.getElementById('customAlert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.id = 'customAlert';
            alertDiv.className = `fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 text-white font-semibold transition-all duration-300 ease-in-out transform opacity-0 scale-95`;

            if (type === "success") {
                alertDiv.style.backgroundColor = 'var(--alert-success-bg)';
            } else if (type === "error") {
                alertDiv.style.backgroundColor = 'var(--alert-error-bg)';
            } else if (type === "warning") {
                alertDiv.style.backgroundColor = 'var(--alert-warning-bg)';
            }
            else {
                alertDiv.style.backgroundColor = 'var(--alert-info-bg)';
            }

            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.opacity = '1';
                alertDiv.style.transform = 'translate(-50%, 0) scale(1)';
            }, 50);

            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translate(-50%, -20px) scale(0.9)';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

        // Initialize Firebase and Theme when the window loads
        window.onload = () => {
            initializeFirebase();
            initializeTheme();
        };

        // Add event listeners for the new feature cards (if this page were a dashboard)
        // These are commented out as this is a specific usage log page, not a dashboard.
        // If you intend to navigate to admin pages from here, you would uncomment and adjust.
        /*
        document.getElementById('chemicalInfoCard').addEventListener('click', () => {
            alertPlaceholder("Navigating to Chemical Information page...", "info");
            window.location.href = 'admin-chemical-management.html'; // Redirect to admin chemical management
        });

        document.getElementById('chemicalTrackingCard').addEventListener('click', () => {
            alertPlaceholder("Navigating to Chemical Usage Tracking page...", "info");
            // This page is the chemical usage page itself, so no redirection here.
        });

        document.getElementById('inventoryTrackingCard').addEventListener('click', () => {
            alertPlaceholder("Navigating to Inventory Tracking page...", "info");
            window.location.href = 'admin-inventory-control.html'; // Redirect to admin inventory control
        });
        */
    </script>
</body>
</html>
